<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recycle Bin</title>
    <style>
        /* Keep your existing nice CSS for layout */
        body { font-family: 'Arial', sans-serif; background: #f0fdf4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 500px; }
        
        .scores { display: flex; gap: 20px; margin: 30px 0; }
        .score-box { flex: 1; padding: 20px; border-radius: 15px; background: #f8fafc; border: 2px solid #e2e8f0; }
        .score-box h3 { margin: 0 0 10px 0; color: #64748b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .score-number { font-size: 3rem; font-weight: 800; color: #0f172a; }
        
        .preview-img { width: 100%; height: 250px; background: #eee; border-radius: 15px; object-fit: cover; margin-bottom: 20px; border: 2px solid #ddd; }
        
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #startBtn { grid-column: span 2; background: #22c55e; color: white; }
        #captureBtn { background: #3b82f6; color: white; }
        #finishBtn { background: #ef4444; color: white; } /* Red for finish */

        /* QR Code Modal Overlay */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; animation: popUp 0.3s ease; }
        .qr-image { width: 250px; height: 250px; margin: 20px 0; }
        
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚ôªÔ∏è Smart Bin</h1>
        
        <img id="preview" src="/static/detected.jpg" class="preview-img" onerror="this.src='https://placehold.co/400x300?text=Camera+Ready'">

        <div class="scores">
            <div class="score-box">
                <h3>Plastic</h3>
                <div class="score-number" id="plasticScore">0</div>
            </div>
            <div class="score-box">
                <h3>Cans</h3>
                <div class="score-number" id="canScore">0</div>
            </div>
        </div>

        <div class="buttons">
            <button id="startBtn" onclick="startSession()">‚ñ∂ START SESSION</button>
            <button id="captureBtn" onclick="capture()" disabled>üì∏ SCAN ITEM</button>
            <button id="finishBtn" onclick="finishSession()" disabled>‚èπ FINISH & SAVE</button>
        </div>
        
        <p id="status" style="margin-top: 20px; color: #666; height: 20px;"></p>
    </div>

    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #22c55e;">Great Job! üéâ</h2>
            <p>Scan this code to claim your points:</p>
            <img id="qrCodeImg" class="qr-image" src="" alt="Generating QR...">
            <br>
            <button onclick="location.reload()" style="background: #333; color: white; padding: 10px 30px;">Done / New User</button>
        </div>
    </div>

    <script>
        async function startSession() {
            document.getElementById('status').innerText = "Initializing Camera...";
            try {
                const res = await fetch('/start', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'success') {
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('finishBtn').disabled = false;
                    document.getElementById('status').innerText = "Ready to scan!";
                }
            } catch(e) { alert("Error starting: " + e); }
        }

        async function capture() {
            document.getElementById('status').innerText = "Analyzing...";
            const res = await fetch('/capture', { method: 'POST' });
            const data = await res.json();
            
            if(data.status === 'success') {
                document.getElementById('plasticScore').innerText = data.plastic_count;
                document.getElementById('canScore').innerText = data.can_count;
                document.getElementById('preview').src = data.image_url; // Show detected image
                document.getElementById('status').innerText = `Detected: ${data.prediction} (${data.confidence}%)`;
            } else {
                document.getElementById('status').innerText = "Error scanning.";
            }
        }

        async function finishSession() {
            if(!confirm("Are you done recycling?")) return;
            
            document.getElementById('status').innerText = "Connecting to server...";
            document.getElementById('finishBtn').innerText = "Generating QR...";
            document.getElementById('finishBtn').disabled = true;

            try {
                const res = await fetch('/finish', { method: 'POST' });
                const data = await res.json();
                
                if(data.status === 'success') {
                    // Show Modal with QR
                    document.getElementById('qrCodeImg').src = data.qr_image_url;
                    document.getElementById('qrModal').classList.add('active');
                } else {
                    alert("Error: " + data.message);
                    document.getElementById('finishBtn').disabled = false;
                }
            } catch(e) {
                alert("Network error. Is Next.js running?");
            }
        }
    </script>
</body>
</html>